
<html lang="ja"><head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>😸</text></svg>">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">

  <title>年間一行日記</title>
  <style>
    ::selection {
      background-color: rgba(255, 0, 106, 0.3);
      text-shadow: 2px 3px 9px #9e2c72;
    }
    body {
      margin: 0;
      padding: 20px;
      background-color: rgba(255, 253, 245, 0.788);
      font-family: serif;
      color: #530c38;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      box-shadow: #cfff82a1 -3px -3px 90px;
    }
    th {
      word-break: keep-all;
      font-size: 20px;
      letter-spacing: 1px;
    }
    th,
    td {
      border: 1px solid #b2cfdb;
      padding: 8px;
      text-align: left;
    }
    #controls {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    #yearControl {
      display: flex;
      align-items: center;
      background-color: #f0f0f080;
      border-radius: 16px;
      padding: 5px;
      box-shadow: #c4d8e0a1 -3px -3px 16px;
    }
    #yearControl button {
      background-color: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 5px 10px;
    }

    #currentYear {
      font-size: 20px;
      margin: 2px 4px;
      cursor: pointer;
    }

    .saturday {
      background-color: #e6feff83;
    }
    .sunday {
      background-color: #ffe6f281;
    }
    .holiday {
      background-color: #ffe6e680;
    }
    .editable {
      min-width: 200px;
    }
    .hidden {
      display: none;
    }

    th {
      text-align: center;
    }
    td:nth-child(1),
    td:nth-child(2),
    td:nth-child(3) {
      text-align: center;

      font-weight: bold;
    }
    td:nth-child(1) {
      font-size: 18px;
    }
    td:nth-child(3) {
      word-break: keep-all;
      letter-spacing: -2px;
    }
    td:nth-child(4) {
      letter-spacing: -1px;
      line-height: 29px;
      font-feature-settings: "palt" 1;
      font-size: 17px;
    }
    /* メディアクエリを追加 */
    @media (max-width: 650px) {
      th,
      td:nth-child(2),
      td:nth-child(3) {
        display: none; /* 曜日、祝日を非表示に */
      }

      td:nth-child(1),
      td:nth-child(4) {
        display: block; /* ブロック要素に変更 */
        width: auto; /* 幅を100%に */
        border-bottom: none;
      }

      td:nth-child(1) {
        order: 1; /* 上段に配置 */
        width: auto;
      }

      td:nth-child(4) {
        order: 2; /* 下段に配置 */
        font-size: 14px; /* 日記のエントリーを目立たせる */
        padding: 10px; /* パディングを調整 */
      }

      tr {
        display: flex; /* フレックスボックスに変更 */
        flex-direction: column; /* 縦方向に配置 */
      }

      table {
        width: 100%; /* テーブルの幅を100%に */
      }
    }
  </style>
</head>
<body>
  <div id="controls">
    <div id="yearControl">
      <button id="prevYear">◀</button>
      <span id="currentYear">2025</span>
      <button id="nextYear">▶</button>
    </div>
  </div>

  <table id="diaryTable">
    <thead>
      <tr>
        <th>何時</th>
        <th>曜</th>
        <th>祝祭</th>
        <th>記述</th>
      </tr>
    </thead>
    <tbody id="diaryBody"></tbody>
  </table>

  <script>

    let entrydata = {};
    const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let activeDays = new Set([0, 1, 2, 3, 4, 5, 6]);
    const yearControl = document.getElementById("yearControl");
    const diaryBody = document.getElementById("diaryBody");

    function loadFromHTML() {
      const backupTag = document.getElementById("backupData");
      if (backupTag) {
        try {
          const parsed = JSON.parse(backupTag.textContent);
          // LocalStorageのデータとHTMLのデータを統合
          for (let key in parsed) {
            if (!entrydata[key] || entrydata[key] === "") {
              entrydata[key] = parsed[key];
            }
          }
          saveToLocalStorage();
        } catch (e) {
          console.error("HTML埋め込みデータのパースに失敗", e);
        }
      }
    }

    function loadFromLocalStorage() {
      const savedData = localStorage.getItem("diaryData");
      if (savedData) {
        entrydata = JSON.parse(savedData);
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem("diaryData", JSON.stringify(entrydata));
    }

    function filterTable() {
      const rows = document.querySelectorAll("#diaryBody tr");

      rows.forEach((row) => {
        const dayOfWeek = row.cells[1].textContent;
        const dayIndex = dayNames.indexOf(dayOfWeek);
        const contentCell = row.cells[3];
        const content = contentCell.textContent.toLowerCase();

        const matchDay = activeDays.has(dayIndex);

        if (matchDay) {
          row.classList.remove("hidden");

          contentCell.textContent = contentCell.textContent;
        } else {
          row.classList.add("hidden");
        }
      });
    }
    function loadYear(year) {
      currentYear = year;

      const table = document.getElementById("diaryBody");
      table.innerHTML = "";

      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);

      for (
        let d = new Date(startDate);
        d <= endDate;
        d.setDate(d.getDate() + 1)
      ) {
        const row = table.insertRow();
        const dateCell = row.insertCell(0);
        const dayCell = row.insertCell(1);
        const holidayCell = row.insertCell(2);
        const contentCell = row.insertCell(3);

        const formattedDate = `${d.getFullYear()}-${(d.getMonth() + 1)
          .toString()
          .padStart(2, "0")}-${d.getDate().toString().padStart(2, "0")}`;
        dateCell.textContent = formattedDate;
        dayCell.textContent = dayNames[d.getDay()];

        contentCell.className = "editable";
        contentCell.contentEditable = true;
        contentCell.textContent = entrydata[formattedDate] || "";

        if (d.getDay() === 0) {
          row.classList.add("sunday");
        } else if (d.getDay() === 6) {
          row.classList.add("saturday");
        }

        const holiday = holidays.find((h) => h.date === formattedDate);
        if (holiday) {
          row.classList.add("holiday");
          holidayCell.textContent = holiday.name;
        }
      }

      filterTable();
      const today = new Date();
      const todayFormatted = `${today.getFullYear()}-${(today.getMonth() + 1)
        .toString()
        .padStart(2, "0")}-${today.getDate().toString().padStart(2, "0")}`;
      const todayRow = Array.from(table.getElementsByTagName("tr")).find(
        (row) => row.cells[0].textContent === todayFormatted
      );
      document.getElementById("currentYear").textContent = year;
      if (todayRow) {
        todayRow.scrollIntoView({ behavior: "smooth", block: "center" });
        todayRow.style.transition = "background-color 1s";
        todayRow.style.backgroundColor = "#ffeb3b50";
        setTimeout(() => {
          todayRow.style.backgroundColor = "";
        }, 2000);
      }
    }

    document
      .getElementById("prevYear")
      .addEventListener("click", () => loadYear(currentYear - 1));
    document
      .getElementById("nextYear")
      .addEventListener("click", () => loadYear(currentYear + 1));

    document.getElementById("diaryBody").addEventListener("input", (e) => {
      if (e.target.className === "editable") {
        const row = e.target.parentElement;
        const date = row.cells[0].textContent;
        const content = e.target.textContent;
        entrydata[date] = content;
        saveToLocalStorage();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        const dataToCopy = JSON.stringify(entrydata);
        const diaryData = '<script id="backupData" type="application/json">' + dataToCopy + '</script>';
        navigator.clipboard
          .writeText(diaryData)
          .then(() => {
            showToast("最新のデータをクリップボードにコピーしました！");
          })
          .catch((err) => {
            showToast("コピーに失敗しました: " + err);
          });
    
        setTimeout(() => {
          location.href = "https://github.com/buzomo/toh-diary/edit/main/index.html";
        }, 3000);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadFromLocalStorage();
      loadFromHTML();
      loadYear(currentYear);
    });
  </script>


</body></html>